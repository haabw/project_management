<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <meta charset="UTF-8"/>
  <title layout:fragment="title">ê´€ë¦¬ì í˜ì´ì§€</title>
  <link rel="stylesheet" th:href="@{/css/main.css}"/>
  <link rel="stylesheet" th:href="@{/css/sidebar.css}"/>
  <link rel="stylesheet" th:href="@{/css/submenu.css}"/>
  <link rel="stylesheet" th:href="@{/css/admin.css}"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div layout:fragment="content">
 <div class="admin-tabs">
    <a th:href="@{/admin(section='dashboard', projectId=${projectId})}" th:classappend="${section=='dashboard'} ? 'active' : ''">ëŒ€ì‹œë³´ë“œ</a>
    <a th:href="@{/admin(section='members', projectId=${projectId})}" th:classappend="${section=='members'} ? 'active' : ''">íŒ€ì› ê´€ë¦¬</a>
    <a th:href="@{/admin(section='permissions', projectId=${projectId})}" th:classappend="${section=='permissions'} ? 'active' : ''">ê¶Œí•œ ì„¤ì •</a>
    <a th:href="@{/admin(section='chat', projectId=${projectId})}" th:classappend="${section=='chat'} ? 'active' : ''">ì±„íŒ… ì´ë ¥</a>
  </div>

  <!-- ë°ì´í„° ì „ë‹¬ìš© hidden ìš”ì†Œ -->
  <div id="projectInfo" th:attr="data-project-id=${projectId}" style="display:none;"></div>

  <!-- ì „ì—­ JS ë³€ìˆ˜ ì •ì˜ -->
  <script th:inline="javascript">
    window.pendingIds  = /*[[${pendingUserIds}]]*/ [];
    window.approvedIds = /*[[${approvedUserIds}]]*/ [];
  </script>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <section th:if="${section=='dashboard'}">
    <h2>ëŒ€ì‹œë³´ë“œ</h2>
    <p>ì˜¤ëŠ˜ ì ‘ì†ì: <strong th:text="${todayUv} + ' ëª…'">0 ëª…</strong></p>
    <h3>ì¼ì¼ ì ‘ì†ì í†µê³„</h3>
    <canvas id="uvChart" width="600" height="300"></canvas>
    <script th:inline="javascript">
      const labels = /*[[${uvLabels}]]*/ [];
      const data   = /*[[${uvCounts}]]*/ [];
      const ctx = document.getElementById('uvChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{ label: 'ì¼ì¼ ì ‘ì†ì ìˆ˜', data: data, fill: false, tension: 0.1 }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, min: 0, max: 10, ticks: { stepSize: 1 } }
          }
        }
      });
    </script>
  </section>

  <!-- íŒ€ì› ê´€ë¦¬ -->
  <section th:if="${section=='members'}">
    <h2 style="margin-bottom: 1.5rem;">íŒ€ì› ê´€ë¦¬</h2>
    <div style="position: relative;">
      <button id="inviteButton" class="btn btn-primary btn-sm" style="position: absolute; top: -2.2rem; right: 0;" onclick="openInviteUserModal()">ì´ˆëŒ€</button>
      <div style="max-height: 400px; overflow-y: auto;">
        <table class="table table-bordered text-center align-middle">
          <thead>
            <tr>
              <th style="background-color:#f0f8ff;">ë‹‰ë„¤ì„</th>
              <th style="background-color:#f0f8ff;">E-mail</th>
              <th style="background-color:#f0f8ff;">ìƒì„±ì¼ì</th>
              <th style="background-color:#f0f8ff;">ê¶Œí•œ</th>
              <th style="background-color:#f0f8ff;">ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="u : ${users}">
              <td th:text="${u.nickname}">ë‹‰ë„¤ì„</td>
              <td th:text="${u.email}">email@example.com</td>
              <td th:text="${u.createdDate != null} ? ${#temporals.format(u.createdDate, 'yyyy-MM-dd')} : '-'">ë‚ ì§œ</td>
              <td th:text="${u.role}">USER</td>
              <td>
                <div th:if="${(currentUserRole=='ADMIN' or (currentUserRole=='EDITOR' and u.role!='ADMIN')) and currentUserId != u.id}">
                  <button type="button" class="btn btn-sm btn-outline-danger" th:onclick="|confirmKick(${u.projectMemberId})|">ì¶”ë°©</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ê¶Œí•œ ì„¤ì • -->
  <section th:if="${section=='permissions'}">
    <h2 style="margin-bottom: 1.5rem;">ê¶Œí•œ ì„¤ì •</h2>
    <div style="max-height: 400px; overflow-y: auto;">
      <table class="table table-bordered text-center align-middle">
        <thead>
          <tr>
            <th style="background-color:#f0f8ff;">ë‹‰ë„¤ì„</th>
            <th style="background-color:#f0f8ff;">E-mail</th>
            <th style="background-color:#f0f8ff;">ìƒì„±ì¼ì</th>
            <th style="background-color:#f0f8ff;">ê¶Œí•œ</th>
            <th style="background-color:#f0f8ff;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="u : ${users}">
            <td th:text="${u.nickname}">ë‹‰ë„¤ì„</td>
            <td th:text="${u.email}">email@example.com</td>
            <td th:text="${u.createdDate != null} ? ${#temporals.format(u.createdDate, 'yyyy-MM-dd')} : '-'">ë‚ ì§œ</td>
            <td th:text="${u.role}">USER</td>
            <td>
              <div th:if="${(currentUserRole=='ADMIN' or (currentUserRole=='EDITOR' and u.role!='ADMIN')) and currentUserId != u.id}">
                <select th:id="'roleSelect' + ${u.id}" class="form-select form-select-sm d-inline-block w-auto">
                  <option value="ADMIN" th:selected="${u.role=='ADMIN'}">ADMIN</option>
                  <option value="EDITOR" th:selected="${u.role=='EDITOR'}">EDITOR</option>
                  <option value="USER" th:selected="${u.role=='USER'}">USER</option>
                </select>
                <button type="button" class="btn btn-sm btn-outline-primary" th:onclick="|submitChangeRole(event, ${u.id})|">ë³€ê²½</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ì±„íŒ… ì´ë ¥ -->
  <section th:if="${section=='chat'}">
    <h2>ì±„íŒ… ì´ë ¥</h2>
    <ul>
      <li th:each="c : ${chatLogs}">
        <strong th:text="${c.user.nickname}">user</strong>:
        <span th:text="${c.message}">message</span>
        <small th:text="${c.timestamp}">time</small>
      </li>
    </ul>
  </section>

  <!-- ì´ˆëŒ€ ì•Œë¦¼ìš© ì„¹ì…˜ -->
  <section th:if="${section=='invitation'}" style="padding: 2rem;">
    <h1>í™˜ì˜í•©ë‹ˆë‹¤</h1>
    <div style="margin-top:1rem; padding: 1rem; background:#f8f9fa; border:1px solid #ddd;">
      <h2><strong>COOPì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</strong></h2>
      <p>í˜‘ì—…ì„ ìœ„í•œ ìµœê³ ì˜ í”Œë«í¼ì—ì„œ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.</p>
    </div>
    <div id="inviteAlert" th:if="${pendingRaw != null and pendingRaw.size() > 0}" style="margin-top:2rem;">
      <h3>ğŸ“¬ ì´ˆëŒ€ë°›ì€ í”„ë¡œì íŠ¸</h3>
      <ul>
        <li th:each="inv : ${pendingRaw}">
          <span th:text="${inv[1]}"></span>ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤.
          <button type="button" class="accept-inv" th:attr="data-invite-id=${inv[0]}" onclick="handleAcceptInvite(this)">ìˆ˜ë½</button>
          <button type="button" class="decline-inv" th:attr="data-invite-id=${inv[0]}" onclick="handleDeclineInvite(this)">ê±°ì ˆ</button>
        </li>
      </ul>
    </div>
  </section>

  <!-- ì´ˆëŒ€ ëª¨ë‹¬ì°½ -->
  <div id="inviteModal" style="display:none; position:fixed; top:20%; left:30%; width:40%; background:white; padding:1rem; border:2px solid #333; z-index:1000; box-shadow:0 0 10px rgba(0,0,0,0.5);">
    <h2 style="text-align:center;">ìœ ì € ì´ˆëŒ€í•˜ê¸°</h2>
    <div id="invite-user-table-container" style="max-height:300px; overflow-y:auto;">
      <table style="width:100%; margin-top:1rem; border-collapse:collapse;">
        <thead>
          <tr style="background-color:#f0f8ff;">
            <th style="padding:0.5rem; border:1px solid #ddd; text-align: center;">ë‹‰ë„¤ì„</th>
            <th style="padding:0.5rem; border:1px solid #ddd; text-align: center;">E-mail</th>
            <th style="padding:0.5rem; border:1px solid #ddd; text-align: center;">ì´ˆëŒ€</th>
          </tr>
        </thead>
        <tbody id="inviteUserList"></tbody>
      </table>
    </div>
    <div style="text-align:center; margin-top:1rem;">
      <button onclick="closeInviteModal()">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ì™¸ë¶€ admin.js ì—°ê²° -->
  <script th:src="@{/js/admin.js}"></script>
</div>
</body>
</html>